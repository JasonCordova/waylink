const csrfToken = document.querySelector('meta[name="_csrf"]').content;
const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

const shortUrlTitle = document.getElementById("stats-title");
const urlId = shortUrlTitle.dataset.shortUrl;

const clickCountElement = document.querySelector(".stats-clicks-label");
var clickCount = parseInt(clickCountElement.textContent);

const tableBody = document.querySelector("tbody");

const noRecords = document.querySelector(".no-records");

const socket = new SockJS("/ws");
const stompClient = Stomp.over(socket);
Stomp.debug = null;

function getDeviceSvg(device){

    switch(device){

        case "Desktop":
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 165 156"><path d="M61 136H22c-5.41 0-13.36.78-17.79-2.7C-.17 129.86.01 125.01 0 120V29C0 21.71-2.07 6.16 5.1 2.17 7.6.79 11.2 1 14 1h138c3.79.06 6.85.16 9.57 3.23 2.76 3.1 2.42 6.92 2.43 10.77v91c0 4.99.79 20.27-1.17 23.96-1.46 2.73-3.95 4.33-6.83 5.24-2.87.9-6.02.8-9 .8h-43c.78 10.05 6.82 9.57 8 20H60c-16.13-.11-.57-8.68 1-20Zm86-118H17v93h130V18Z"/></svg>`;
        case "Mobile":
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 290 512"><path d="M32 .11h218C275.47.04 289.96 15.93 290 41v432c-.29 24.13-16.14 38.96-40 39H40c-25.47-.04-39.96-15.93-40-41V58C0 36.84-2.47 15.74 20 4.27c4.6-2.34 7.02-2.9 12-4.16ZM91.13 23.6c-4.86 3.21-5.75 11.85-.85 15.66 2.6 2.03 6.58 1.73 9.72 1.74h92c3.14-.05 6.18-.04 8.57-2.43 2.97-2.97 5.66-15.34-6.57-15.57h-67l-35.87.6ZM262 63H28v331h234V63ZM140 428.33c-4 .96-6.62 2-9.91 4.6-18.26 14.42-6.16 46.53 19.91 41.6 18.07-3.41 24.45-25.96 12.48-39.35-6-6.71-14.02-7.79-22.48-6.85Z"/></svg>`;
        case "Tablet":
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 334 452"><path d="M21 1.52 50 1h245c16.68 0 31.52-1.01 37.21 19 .89 3.13.79 5.8.79 9v394c-.03 18-10.04 27.97-28 28H39c-16.59 0-31.56.9-37.21-19-.89-3.13-.79-5.8-.79-9V29C1.02 14.76 6.85 5.33 21 1.52ZM315 388V32c-.02-11.76-2.62-12.98-14-13H42c-4.45 0-15.36-.62-18.89 1.31-4.57 2.5-4.1 7.22-4.11 11.69v356h296Zm-152 19.42c-17.39 6.17-9.06 29.79 7 26.19 10.46-2.35 14.3-15.56 6.61-23.08-3.92-3.82-8.56-3.85-13.61-3.11Z"/></svg>`;
        default:
            return "";

    }

}

function getOsSvg(os){

    switch (os){

        case "Windows":
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 320"><path d="M146 153V34l1.6-7.98 10.4-2.27 28-4.02L319 0v152l-26 1H146ZM1 47l96-14.13L131 28v125H76l-21 1H1V47Zm0 120 18 1h112v126l-43-6.28-56-7.87-22-3.12-7.98-2.33L1 267V167Zm145 1h93l21 1h59v151l-124-17.28-49-6.72V168Z"/></svg>`;
        case "iOS":
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 208 256"><path d="M155 0v7c-.22 18.78-11.87 36.92-28 46.13-4.32 2.47-17.87 8.43-22.4 4.85-4.05-3.2.58-17.86 2.1-21.98C113.78 16.73 134.36.96 155 0Zm53 188c-3.92 16.75-19.22 41.66-31.04 54-7.58 7.92-14.64 13.19-25.96 13.79-9.68.52-18.2-4.7-27-7.71-6.9-2.37-10.89-2.16-18-2.08-16.95.2-28.98 13-45 9.32-13.03-2.99-21.53-14.2-29.13-24.32C14.15 207.38.35 173.9 0 144c-.39-33.94 11.16-68.06 47-78.96 7.53-2.29 12.31-2.13 20-2.04 15.21.18 29.73 11.19 40 10.37l29-9.48c18.53-4.65 38.86-1.13 54 10.78 4.92 3.87 8.69 7.43 11 13.33-8.19 5.82-14.26 11.29-19.54 20-11.2 18.49-9.79 42.48 2.58 60 6.8 9.62 14.19 14.14 23.96 20Z"/></svg>`;
        case "Android":
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 217 256"><path d="M62 1c9.41-1.22 9.34 15.95 16.21 18.65 2.42.95 7.25-1.2 9.79-1.91 5.77-1.59 13.02-2.71 19-2.74 7.45-.03 12.72.52 20 2.24l9.96 2.69c6.45.02 9.47-16.23 14.43-18.86 1.51-.72 2.2-.25 3.61 0L144 24c22.87 10.22 34.06 32.09 36 56H37c.51-23.46 14.29-46.3 36-56L62 1Zm12.11 42.62c-7.71 4.83-1.38 11.98 3.78 10.27 5.58-1.85 5.43-11.59-3.78-10.27Zm64.95 0c-8.01 4.84-1.44 12.45 3.88 10.1 5.43-2.39 4.93-11.35-3.88-10.1ZM12 83.53C25.99 81.27 31.94 90.1 32 103v56c-.02 9.86-1.73 18.9-13 21.3-7.63 1.63-15.65-2.92-18.15-10.3-.97-2.88-.85-6-.85-9v-60c.11-9.04 3-14.58 12-17.47Zm185 0c14.38-2.36 19.98 6.32 20 19.47v59c-.02 5.04-.17 8.77-3.56 12.9-7 8.55-19.85 7.1-25.72-1.9-2.33-3.59-2.67-7.85-2.72-12v-59c.11-9.03 2.89-15.55 12-18.47ZM38 86h141v100c-.01 2.72.02 5.37-.8 8-4.01 12.8-16.68 11-27.2 11v31c-.01 5.29.1 9.56-3.42 13.96-6.7 8.38-19.81 7.91-25.88-.98-2.63-3.84-2.68-7.53-2.7-11.98v-32H98v31c-.01 5.29.1 9.56-3.42 13.96-6.59 8.24-19.79 8.09-25.59-.98-2.73-4.27-2.97-8.1-2.99-12.98v-31c-10.52 0-23.19 1.8-27.2-11-.74-2.36-.77-4.56-.8-7V86Z"/></svg>`;
        case "MacOS":
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 285 256"><path d="M11 .53 36 0h225c5.7 0 13.1-.78 17.91 2.7 5.87 4.25 6.08 10.76 6.09 17.3v218c-.06 5.09-.61 9.91-4.34 13.78-4.15 4.3-9.16 4.21-14.66 4.22H24c-5.7 0-13.1.78-17.91-2.7C.22 249.05.01 242.54 0 236V18C.11 9.26 2.05 3.41 11 .53ZM256 28H144c-2.04 0-5.63-.26-7.3.99-1.69 1.27-2.72 5.02-3.36 7.01l-4.54 18c-2.96 14.58-6.73 40.43-6.8 55l-1 19v14h43c-2.41 13.44-2 27.38-2 41 18.3-1.54 42.84-13.9 58-24 2.8 5.72 6.85 10.68 10.33 16 1.18 1.79 3.36 4.66 2.95 6.91-.69 3.79-11.82 9.06-15.28 10.87-14.27 7.46-36.89 17.47-53 18.22.25 3.07 1.38 14.26 3.59 15.98 1.62 1.26 5.4 1.02 7.41 1.02h80V28ZM68 57.39c-4.05 1.31-6.68 2.81-8.91 6.63C56.42 68.57 56.99 74.86 57 80c.02 10.96 4.63 22.3 18 18.93C86.18 96.11 86.04 85.23 86 76c-.06-12.02-4.66-20.38-18-18.61Zm141 .26c2.26-.47 3.65-.75 6-.54 13.87 1.19 13.12 14.65 13 24.89-.12 9.42-5.07 18.76-16 17.44-16.85-2.02-14.73-29.21-10.01-36.4 2.07-3.15 3.69-3.98 7.01-5.39ZM142 185c-18.57-.06-37.24-5.61-54-13.31l-16-8.75c-1.87-1.12-4.53-3.16-6.82-2.5-2.75.79-10.69 13.55-12.47 16.56-1.01 1.73-2.27 3.71-1.47 5.79 1 2.59 9.13 7.03 11.76 8.43C89.46 205.27 111.8 213 142 213v-28Z"/></svg>`;
        case "Linux":
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 217 256"><path d="M101 .22h8c4.17-.11 10.05.84 14 2.14 34.75 11.38 20.45 55.65 32.27 79.64 5.98 12.13 15.16 21.97 22.7 33 9.4 13.75 16 30.18 16.03 47l-.98 17c.54 3.12 2.61 4.39 4.08 10 .9 3.46.91 6.81 2.91 9.91 5 7.76 17.09 8.15 16.67 17.09-.39 8.38-12.89 10.76-22.68 17.36-9.26 6.24-21.84 20.58-32 22.31-5.7.98-13.35-.92-17.9-4.46-2.69-2.09-3.93-4.82-7.2-6.06-4.4-1.67-24.53-2.6-29.9-2.41-6.67.25-13.72.15-20 2.74-9.49 3.91-7.6 8.84-22 8.51-9.35-.22-27.39-7.88-38-10.52-6.29-1.56-21.49-3.03-25.44-7.86-2.14-2.7-1.36-5.76 0-8.61 2.7-5.88 4.61-6.82 4.49-14-.3-6.84-3.59-14.62 0-20.96 5.74-9.76 15.61-.55 20.69-9.1 3.9-6.57.7-10.82 4.6-19.94l11.43-23c2.82-7.53 3.89-16.04 7.74-23 4.71-8.5 11.92-15.12 17.45-23C78.73 78.64 72.08 66.82 72 50V33c.13-11.08 4.58-23.65 15-29.01 4.85-2.49 8.8-2.78 14-3.77ZM127 65c.54-6.72 1.1-6.22 1-14-.03-2.39-.04-4.71-1.01-6.96-3.05-7.11-12.93-7.6-17.34-2.65-3 3.37-2.98 8.5-1.71 12.59.93 2.99 1.49 3.48 4.06 5.02-.72-4.55-1.07-10.46 4.06-12.77 5.5-2.48 10.64 5.69 9.12 10.76-.68 2.25-2.66 4.26-4.18 6.01l6 2Zm-34-8c.85-3 1.22-4.85.67-8-.28-1.63-.86-3.49-1.76-4.89-1.2-1.88-2.73-3.14-4.93-3.66C75.99 37.83 72.89 62.89 84 63c-1.84-3.06-4.23-6.21-3.68-10 .56-3.84 4.27-8.32 8.27-5.24 2.45 1.89 3.07 6.37 4.41 9.24Zm-4-3c-.49-4.1-.55-4.65-4-7l-1 3 5 4Zm35 0c-1.43-4.27-1.38-5.19-6-6l6 6ZM81 79c8.56 18.11 24.87 12.64 38 4 3.25-2.14 10.2-6.12 11.12-10.01 1.08-4.57-4.76-7.15-8.12-8.54-7.89-3.26-21.09-9.57-29-4.45l4-1-4 4v-3c-4.73 1.38-14 6.17-13.92 11.96.09 6.77 12.5 10.28 17.92 9.95 10.13-.62 16.59-6.21 25-10.91-5.02 6.37-18.66 13.49-27 12.66-5-.49-9.37-2.99-14-4.66Zm20-20 4 4c-3.07-1.07-2.93-.93-4-4ZM81 78h-1l1 1v-1Zm47 2c-7.86 3.55-22.31 18.53-36 12.99-3.26-1.31-6.94-4.83-10-6.99l-9.4 22-4.4 14c-5.59 12.58-12.24 21.87-14.97 36-.46 3.93-.23 10.76 0 15-2.57-2.64-4.34-4.46-5.25-8-2.9-11.31 7.69-29.46 13.02-39-4.54 0-5.36 3.24-7.24 7-3.55 7.08-8.55 18.13-8.75 26-.48 20.08 15.9 21.9 30.99 37 5.31 5.32 11.91 11.15 2.96 17.28-1.47 1.01-2.37 1.18-3.96 1.72 3.93 13.31 15.4 13.13 27 13 13.98-.17 29.65-7.66 37.94-19 5.85-8 .12-12.47 2.62-22 1.94-7.4 5.43-9.17 12.44-8 1.42-5 1-9.85 1-15 0-10.52.14-19.93-3.83-30l-10.38-19-3.74-13-5.45-11-4.6-11Zm40.84 89c3.39-11.17 5.47-27.37 0-38-3.15-5.64-6.93-10.64-13.84-10 3.89 3.4 8.27 6.43 10.92 11 4.93 8.49 4.88 25.28.51 33.99-3.02 6.03-7.05 5.38-10.43 14.01l9-6.85c5.2-2.7 14.39-1.09 18.96 2.34L191 182c-2.3-11.26-12.13-12.55-22.16-13ZM38 176.53c-9.5 2.13-5.96 7.81-11.22 11.62-4.55 3.28-11.43.6-15.65 3.02-8.06 4.64-1.28 17.61-2.46 24.83-1.18 7.18-7.36 12.97-4.63 17.78 2.34 4.14 11.6 5.01 15.96 5.83 8.55 1.6 16.84 3.76 25 6.81 7.01 2.62 16.45 6.54 24 5.37 11.96-1.86 13.4-12.17 10.25-21.79-3.48-10.62-10.98-19.07-17.34-28l-9.27-15c-3.71-5.48-7.73-9.92-14.64-10.47ZM193 184c-8.46 2.48-12.68 12.85-22 13.5-5.34.37-10.3-3.03-12.91-7.5-1.56-2.67-1.87-5.76-3.65-7.4-5.62-5.18-8.8 3.09-9.35 7.4v6l-1.38 36c-.96 7.74-4.01 13.67 4.33 18.77 2.95 1.81 5.6 2.14 8.96 2.21 16.24.35 25.87-16.42 39-23.67 5.04-2.79 19.19-6.91 17.16-14.31-1.44-5.22-8.23-6.95-13.05-12.04-4.88-5.15-5.76-12.26-7.11-18.96Z"/></svg>`;
        default:
            return "";
    }

}

function getDateSvg(){

    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M148 .53 177 0c3.4.02 5.7-.02 9 1.11C202.08 6.62 202 19 202 33v48c0 13.35.78 25.99-14 32.47-7.65 3.35-21.45 2.63-30 2.53-12.38-.15-22.67-4.42-26.9-17-1.66-4.96-1.1-14.46-1.1-20V42c0-17.59-3.39-35.09 18-41.47Zm190 0L367 0c3.4.02 5.7-.02 9 1.11C392.08 6.62 392 19 392 33v48c0 13.35.78 25.99-14 32.47-7.65 3.35-21.45 2.63-30 2.53-12.38-.15-22.67-4.42-26.9-17-1.66-4.96-1.1-14.46-1.1-20V42c0-17.59-3.39-35.09 18-41.47ZM416 41c16 0 27.41-.85 43 4.7 30.6 10.88 52.95 40.55 53 73.3v316c-.06 40.71-36.29 76.94-77 77H77c-40.8-.06-76.94-36.2-77-77V119c.05-33.57 24-64.63 56-74.28C72.82 39.65 88.66 41 106 41v49c.26 21.56 14.89 41.75 36 47.51 8.47 2.31 27.47 1.6 37 1.49 9.62-.12 19.37-3.65 27-9.53 20.55-15.83 20-32.26 20-55.47V41h70v49c.26 21.56 14.89 41.75 36 47.51 8.47 2.31 27.47 1.6 37 1.49 9.62-.12 19.37-3.65 27-9.53 20.55-15.83 20-32.26 20-55.47V41ZM58 178.1C45.03 182.25 40.16 191 40 204v225c.04 26.27 16.73 42.96 43 43h346c26.27-.04 42.96-16.73 43-43V214c0-14.7.98-29.1-16-35.04-3.19-1.11-5.7-.95-9-.86H58Z"/></svg>`;

}

function getLocationSvg(){

    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 322 512"><path d="M151 .63c7.73-1.15 15.31-.54 23 0 18.95 2.04 31.12 4.49 49 11.57 16.44 6.52 31.62 16.77 45 28.23 9.78 8.37 20.26 20.75 27.31 31.57 13.56 20.83 23.12 46.16 25.65 71v9l1 11c-1.02 26.38-7.98 53.05-16.29 78-11.18 33.54-25.62 66.4-41.42 98l-24.94 48c-17.47 32.22-35.88 63.95-55.36 95L170 504c-1.86 2.75-4.39 6.98-8.01 7.42-3.94.49-6.77-3.69-8.86-6.42l-17.46-25-47.25-75-18.28-33-21.39-42-23.17-54C14.2 246.1 4.21 212.95 1.04 181v-9L.01 162l1.03-10v-9c2.34-22.81 10.77-46.45 22.56-66C29.71 66.87 37.68 56.41 46 48c10.93-11.04 25.24-21.95 39-29.22 14.3-7.55 32.99-14.15 49-16.51l17-1.64Zm2 89.65c-13.09 1.93-22.98 4.72-34 12.44-8.41 5.89-16.03 13.49-21.39 22.28-22.17 36.4-9.29 86.28 29.39 105.63 13.83 6.92 29.78 9.09 45 7.08 8.2-1.08 18.87-4.56 26-8.73 44.67-26.1 50.23-88.11 11-121.68-6.78-5.81-13.63-9.82-22-12.86-10.86-3.96-22.51-5.22-34-4.16Z"/></svg>`;

}

function getTimeSvg(){

    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 799"><path d="M369 .21h37l12 .7 15 .92 29 2.46c16.17 2.18 35.34 7 51 11.67 44.49 13.27 89.04 34.09 126 62.47 43.13 33.11 80.72 74.56 108.14 121.57 18.44 31.61 35.44 74.2 43.19 110l1.33 8c3.23 15.37 7.32 35.41 7.34 51v16l.96 16-.96 11v20c-.13 10.68-4.18 35.09-6.58 46-4.23 19.29-8.86 38.35-15.51 57-15.05 42.18-37.96 82.37-66.33 117l-15.38 17.17c-30.95 34.42-69.88 64.87-111.2 85.87-34.18 17.36-69.42 29.56-107 36.96l-13 2.71c-26.7 4.12-54.02 4.6-81 4.29l-10-.91c-34.3-2.35-51.78-5.18-85-14.66-40.19-11.47-78.42-29.24-113-52.77-20.89-14.22-29.21-21.68-47.42-38.66-44.01-41.03-77.28-88.05-99.66-144-8.95-22.37-15.16-45.49-20.13-69-2.8-13.23-6.77-35.81-6.79-49v-16l-.99-16L1 384v-15c.02-13.14 4-35.81 6.79-49 5.05-23.91 11.63-47.24 20.66-70C65.11 157.63 144.07 75.08 235 34.86c25.1-11.1 52.17-20.38 79-26.19l9-1.47 21-3.92 25-3.07Zm7 87.93-12 1.03-22 3.29c-21.96 3.99-51.45 14.01-72 22.87-10.86 4.69-24.95 12.65-35 18.99-57.15 36.03-102.37 90.8-127.08 153.68-8.25 21.01-15.6 48.54-17.75 71-1.95 20.41-1.41 48.97-1.17 70 .25 21.32 9.55 55.77 16.95 76 5.53 15.14 11.66 29.9 19.55 44 32.45 57.99 84.09 107.05 144.5 135.12l28 10.74c24.51 8.51 50.17 13.34 76 15.23l10 .91h31c11.32-.02 22.82-1.95 34-3.57 31.35-4.55 62.82-13.44 91-28.32C619.65 637.05 681.91 564.44 702.88 476c3.48-14.66 8.1-38.19 8.12-53v-46c-.02-10.11-2.1-20.03-3.57-30-2.93-19.74-7.8-39.29-14.85-58C668.4 224.92 619.23 167.58 561 131.91c-15.65-9.59-31.04-16.57-48-23.36-14.29-5.71-39.98-13.76-55-16.11l-17-1.6L419 89h-4l-15-.86h-24Zm3 84.09h21c14.95-.05 31.13 13.94 35.89 27.77 1.86 5.39 2.05 13.3 2.11 19l1 15v41l1 17v92c.01 2.75-.35 6.17 1.6 8.36 2.07 2.34 8.35 4.27 11.4 5.45l28 10.88 30 11.37 63 24.49c11.19 4.48 32.85 11.62 40.99 19.49 18.34 17.76 19.72 44.32 3.55 63.96-5.03 6.1-12.84 12.03-20.54 14.21-3.81 1.09-6.27.6-10 .96-5.33.51-10.62 1.4-16 .51-3.76-.63-14.9-5.16-19-6.82l-26-10.05-92-35.36-52-20.76c-4.36-1.93-13.49-5.72-16.96-8.32-6.02-4.52-17.05-23.06-19.24-30.37-.9-3.01-.8-5.91-.8-9V258l1-16v-29c.01-5.03.06-8.15 1.8-13 4.17-11.68 18.12-24.66 30.2-27.77Z"/></svg>`;
}

// Override send method to include CSRF
const originalSend = stompClient.send;
stompClient.send = function(destination, headers = {}, body) {
    headers[csrfHeader] = csrfToken;
    originalSend.call(stompClient, destination, headers, body);
};

stompClient.connect({}, function(frame) {

    stompClient.subscribe(`/topic/${urlId}`, function(messageOutput) {

        const recordJSON = JSON.parse(messageOutput.body);
        if (noRecords) noRecords.remove();

        // New record
        const newRow = document.createElement("tr");

        const dateCell = document.createElement("td");
        const timeCell = document.createElement("td");
        const locationCell = document.createElement("td");
        const deviceCell = document.createElement("td");
        const osCell = document.createElement("td");

        const dateCellFlex = document.createElement("div");
        const timeCellFlex = document.createElement("div");
        const locationCellFlex = document.createElement("div");
        const deviceCellFlex = document.createElement("div");
        const osCellFlex = document.createElement("div");

        dateCellFlex.classList.add("flex");
        timeCellFlex.classList.add("flex");
        locationCellFlex.classList.add("flex");
        deviceCellFlex.classList.add("flex");
        osCellFlex.classList.add("flex");

        dateCellFlex.innerHTML = getDateSvg() + ` <span>${new Date(recordJSON['clickedAt'] + "Z").toLocaleDateString(undefined, {
            month: "2-digit",
            day: "2-digit",
            year: "numeric"
        }).toString()}</span>`;

        timeCellFlex.innerHTML = getTimeSvg() + ` <span>${new Date(recordJSON['clickedAt'] + "Z").toLocaleTimeString(undefined, {
            hour: "numeric",
            minute: "2-digit",
            hour12: true
        }).toString()}</span>`;

        locationCellFlex.innerHTML = getLocationSvg() + ` <span>${recordJSON['timeZone']}</span>`;
        deviceCellFlex.innerHTML = getDeviceSvg(recordJSON['device']) + ` <span>${recordJSON['device']}</span>`;
        osCellFlex.innerHTML = getOsSvg(recordJSON['os']) + ` <span>${recordJSON['os']}</span>`;

        dateCell.appendChild(dateCellFlex);
        timeCell.appendChild(timeCellFlex);
        locationCell.appendChild(locationCellFlex);
        deviceCell.appendChild(deviceCellFlex);
        osCell.appendChild(osCellFlex);

        newRow.appendChild(dateCell);
        newRow.appendChild(timeCell);
        newRow.appendChild(locationCell);
        newRow.appendChild(deviceCell);
        newRow.appendChild(osCell);
        tableBody.appendChild(newRow);

        // increment count
        clickCount += 1;
        clickCountElement.innerText = clickCount;
    });

});